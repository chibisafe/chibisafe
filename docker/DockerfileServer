# FROM jrottenberg/ffmpeg:6.1.3-alpine320 AS ffmpeg
FROM node:20-alpine AS runner

RUN apk update
RUN apk add --no-cache libc6-compat git openssl ffmpeg6=6.1.2-r8 ffmpeg6-libs=6.1.2-r8


# COPY --from=ffmpeg /bin/ffmpeg /usr/bin/ffmpeg
# COPY --from=ffmpeg /lib /lib

# RUN chmod +x /usr/bin/ffmpeg

WORKDIR /app
COPY . .
COPY package.json yarn.lock turbo.json tsconfig.json ./

RUN yarn workspaces focus @chibisafe/backend
RUN yarn workspace @chibisafe/backend generate
RUN yarn workspace @chibisafe/backend migrate
RUN yarn workspace @chibisafe/backend build

ENV NODE_ENV=production

EXPOSE 8000
ENV HOSTNAME 0.0.0.0
ENV HOST 0.0.0.0
ENV PORT 8000

CMD ["yarn", "workspace", "@chibisafe/backend", "start"]
