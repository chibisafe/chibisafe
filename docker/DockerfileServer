FROM jrottenberg/ffmpeg:6.1.3-alpine320 AS ffmpeg
FROM node:20-alpine as runner

RUN apk update
RUN apk add --no-cache libc6-compat git openssl

COPY --from=ffmpeg /bin/ffmpeg /usr/bin/ffmpeg
COPY --from=ffmpeg /usr/lib/libavcodec.so.* /usr/lib/
COPY --from=ffmpeg /usr/lib/libavformat.so.* /usr/lib/
COPY --from=ffmpeg /usr/lib/libavfilter.so.* /usr/lib/
COPY --from=ffmpeg /usr/lib/libavdevice.so.* /usr/lib/
COPY --from=ffmpeg /usr/lib/libavutil.so.* /usr/lib/
COPY --from=ffmpeg /usr/lib/libswresample.so.* /usr/lib/
COPY --from=ffmpeg /usr/lib/libswscale.so.* /usr/lib/
COPY --from=ffmpeg /usr/lib/libpostproc.so.* /usr/lib/

RUN chmod +x /usr/local/bin/ffmpeg

WORKDIR /app
COPY . .
COPY package.json yarn.lock turbo.json tsconfig.json ./

RUN yarn workspaces focus @chibisafe/backend
RUN yarn workspace @chibisafe/backend generate
RUN yarn workspace @chibisafe/backend migrate
RUN yarn workspace @chibisafe/backend build

ENV NODE_ENV=production

EXPOSE 8000
ENV HOSTNAME 0.0.0.0
ENV HOST 0.0.0.0
ENV PORT 8000

CMD ["yarn", "workspace", "@chibisafe/backend", "start"]
